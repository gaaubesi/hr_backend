{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load nepali_date %}

{% block title %}
    Create Team Member
{% endblock title %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/select2.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/select2-bootstrap-5-theme.min.css' %}">
    <style>
        /* Highlight the active tab button with primary background and white text */
        .nav-tabs .nav-link.active {
            background-color: #696cff;  /* Bootstrap primary */
            color: white !important;
            border-color: #696cff #696cff #fff;
        }

        .nav-tabs .nav-link {
            color: #696cff; /* Make inactive tabs primary-colored text */
        }

        .profile-picture-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
            border-radius: 50%;
            overflow: hidden;
            background-color: #f8f9fa;
            border: 2px solid #939396;
        }

        .profile-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-picture-container .upload-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            text-align: center;
            color: white;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .profile-picture-container:hover .upload-overlay {
            opacity: 1;
        }

        .profile-picture-container input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* Fix select2 z-index in modals */
        .modal .select2-container {
            z-index: 9999 !important;
        }
        
        .modal .select2-dropdown {
            z-index: 9999 !important;
        }
        
        .modal .select2-results {
            z-index: 9999 !important;
        }
    </style>
{% endblock styles %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-3 mb-4">
            <div class="card text-center">
                <div class="card-body">
                    <div class="profile-picture-container mb-3">
                        {% if profile_picture %}
                            <img src="{{ profile_picture.url }}" alt="Profile Picture" id="profile-preview">
                        {% else %}
                            <i class="fas fa-user fa-5x text-secondary" id="profile-preview" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></i>
                        {% endif %}
                        <div class="upload-overlay">
                            <i class="fas fa-camera"></i> Change Photo
                        </div>
                        <div id="file-input-container">
                            <input type="file" name="profile-profile_picture" id="id_profile_profile_picture" accept="image/*">
                        </div>
                    </div>
                   <h5 class="mb-2">
                        {{ user_form.first_name.value }} {{ user_form.last_name.value }}

                        {% if action == 'Update' %}
                            {% if profile_form.instance.is_verified %}
                                <i class="fas fa-square-check text-success ms-1" title="Verified"></i>
                            {% else %}
                                <i class="fas fa-square-xmark text-danger ms-1" title="Not Verified"></i>
                            {% endif %}

                            {% if profile_form.instance.status == 'currently_working' %}
                                <i class="fas fa-briefcase text-success ms-1" title="Currently Working"></i>
                            {% elif profile_form.instance.status == 'not_working' %}
                                <i class="fas fa-briefcase text-danger ms-1" title="Not Working"></i>
                            {% elif profile_form.instance.status == 'deactivated' %}
                                <i class="fas fa-circle text-danger ms-1" title="Deactivated"></i>
                            {% endif %}
                        {% endif %}
                        
                    </h5>

                    <p class="text-muted mb-1"><i class="fa-solid fa-envelope me-2"></i>{{ user_form.email.value }}</p>
                    <p class="text-muted"><i class="fa-solid fa-phone me-2"></i>{{ profile_form.mobile_number.value }}</p>
                </div>
            </div>
        </div>

        <!-- Right Side Form Tabs -->
        <div class="col-md-9">
            <div class="mb-3">
                <a class="btn btn-outline-info btn-sm" href="{% url 'user:employee_list' %}">Team</a>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs mb-3" id="employeeTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if not active_tab or active_tab == 'profile' %}active{% endif %}" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button">Profile</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'work' %}active{% endif %}" id="work-tab" data-bs-toggle="tab" data-bs-target="#work" type="button">Work</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'document' %}active{% endif %}" id="document-tab" data-bs-toggle="tab" data-bs-target="#document" type="button">Document</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'payout' %}active{% endif %}" id="payout-tab" data-bs-toggle="tab" data-bs-target="#payout" type="button">Payout</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if active_tab == 'bank_detail' %}active{% endif %}" id="bank-detail-tab" data-bs-toggle="tab" data-bs-target="#bank_detail" type="button">Bank Details</button>
                </li>
            </ul>

            <div class="tab-content" id="employeeTabsContent">
                <!-- Profile Tab -->
                <div class="tab-pane fade {% if not active_tab or active_tab == 'profile' %}show active{% endif %}" id="profile" role="tabpanel">
                    <form method="POST" enctype="multipart/form-data" id="profile-form">

                        {% csrf_token %}
                        <input type="hidden" name="form_section" value="profile">
                        <div class="row">
                            <div class="col-md-6">  
                                {{ user_form|crispy }}
                            </div>
                            <div class="col-md-6">
                                {{ profile_form|crispy }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-success">{{ action }}</button>
                            <a href="{% url 'user:employee_list' %}" class="btn btn-warning">Cancel</a>
                        </div>
                    </form>
                </div>

                <!-- Work Tab -->
                <div class="tab-pane fade {% if active_tab == 'work' %}show active{% endif %}" id="work" role="tabpanel">
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="form_section" value="work">
                        <div class="row">
                            <div class="col-md-6">
                                {{ working_form|crispy }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-success">{{ action }}</button>
                            <a href="{% url 'user:employee_list' %}" class="btn btn-warning">Cancel</a>
                        </div>
                    </form>
                </div>

                <!-- Document Tab -->
                <div class="tab-pane fade {% if active_tab == 'document' %}show active{% endif %}" id="document" role="tabpanel">
                    <form method="POST" enctype="multipart/form-data" id="document-form">
                        {% csrf_token %}
                        <input type="hidden" name="form_section" value="document">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="document-forms">
                                    <div class="document-form-item mb-3">
                                        <div class="row g-3">
                                            <div class="col-md-2 pe-2">
                                                <label for="id_document_type-0">Document Type <span class="asteriskField">*</span></label>
                                                <select name="document_type-0" id="id_document_type-0" class="form-select document-type-select" required>
                                                    {% comment %} <option value="">Select Document Type</option> {% endcomment %}
                                                    {% for value, label in document_form.fields.document_type.choices %}
                                                        <option value="{{ value }}" {% if value in uploaded_document_types %}disabled{% endif %}>{{ label }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="col-md-2 px-2">
                                                <label for="id_document_file-0">Document File <span class="asteriskField">*</span></label>
                                                <input type="file" name="document_file-0" id="id_document_file-0" class="form-control" required>
                                            </div>
                                            <div class="col-md-2 px-2">
                                                <label for="id_document_number-0">Document Number</label>
                                                <input type="text" name="document_number-0" id="id_document_number-0" class="form-control" placeholder="Enter doc number"> 
                                            </div>
                                            <div class="col-md-3 px-2">
                                                <label for="id_issue_date-0">Issue Date</label>
                                                <input type="text" name="issue_date-0" id="id_issue_date-0" class="form-control" placeholder="YYYY-MM-DD (BS)">
                                            </div>
                                            <div class="col-md-3 ps-2">
                                                <label for="id_issue_body-0">Issuing Authority</label>
                                                <select class="select2 form-control" name="issue_body-0" id="id_issue_body-0" >
                                                    <option value="">Select Issuing Authority</option>
                                                    {% for district in document_form.fields.issue_body.queryset %}
                                                        <option value="{{ district.id }}">{{ district.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-info" id="add-more-document">
                                        <i class="fas fa-plus"></i> Add More
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-success">{{ action }}</button>
                            <a href="{% url 'user:employee_list' %}" class="btn btn-warning">Cancel</a>
                        </div>
                    </form>

                    <!-- Display existing documents -->
                    <div class="card mt-4">
                        <div class="card-header bg-primary text-white fw-bold reduced-padding">Documents</div> 
                        <div class="card-body">
                            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                                {% for document in documents %}
                                <div class="col" data-document-type="{{ document.document_type }}">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title mb-0 text-truncate" style="max-width: 70%;">
                                                    {{ document.get_document_type_display }}
                                                </h6>
                                                <span>
                                                    <i class="fas fa-calendar-alt me-1"></i>
                                                    {{ document.uploaded_at|date:"M d, Y" }}
                                                </span>
                                            </div>
                                            <div class="small text-muted mb-2">
                                                {% if document.document_number %}
                                                    <div>Document Number: {{ document.document_number }}</div>
                                                {% else %}
                                                    <div style="visibility: hidden;">Document Number placeholder</div>
                                                {% endif %}
                                                
                                                {% if document.issue_date %}
                                                    <div>Issue Date: {{ document.issue_date|to_nepali_date }}</div>
                                                {% else %}
                                                    <div style="visibility: hidden;">Issue Date placeholder</div>
                                                {% endif %}
                                                
                                                {% if document.issue_body %}
                                                    <div>Issuing Authority: {{ document.issue_body }}</div>
                                                {% else %}
                                                    <div style="visibility: hidden;">Issuing Authority placeholder</div>
                                                {% endif %}
                                            </div>

                                            <div class="d-flex gap-2 mt-3">
                                                <button type="button" class="btn btn-outline-primary btn-sm flex-grow-1" data-bs-toggle="modal" data-bs-target="#viewDocumentModal{{ document.id }}">
                                                    <i class="fas fa-eye me-1"></i> View
                                                </button>
                                                <button type="button" class="btn btn-outline-warning btn-sm edit-document-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#editDocumentModal{{ document.id }}"
                                                    data-document-id="{{ document.id }}"
                                                    data-document-type="{{ document.document_type }}"
                                                    data-issue-date="{{ document.issue_date|date:'Y-m-d' }}"
                                                    data-issue-body="{% if document.issue_body %}{{ document.issue_body.id }}{% endif %}">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-danger btn-sm delete-btn"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#confirmationModal"
                                                    data-url="{% url 'user:delete_document' document.id %}"
                                                    data-title="Delete Document">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Document View Modal -->
                                <div class="modal fade" id="viewDocumentModal{{ document.id }}" tabindex="-1" aria-labelledby="viewDocumentModalLabel{{ document.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-md">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="viewDocumentModalLabel{{ document.id }}">{{ document.get_document_type_display }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body p-0">
                                                {% with file_url=document.document_file.url|lower %}
                                                    {% if '.pdf' in file_url %}
                                                        <iframe src="{{ document.document_file.url }}" width="100%" height="500px" frameborder="0"></iframe>
                                                    {% elif '.jpg' in file_url or '.jpeg' in file_url or '.png' in file_url %}
                                                        <img src="{{ document.document_file.url }}" class="img-fluid" alt="{{ document.get_document_type_display }}">
                                                    {% else %}
                                                        <div class="alert alert-info m-3">
                                                            <p class="mb-0">This file type cannot be previewed. <a href="{{ document.document_file.url }}" class="alert-link" target="_blank">Download</a> to view.</p>
                                                        </div>
                                                    {% endif %}
                                                {% endwith %}
                                            </div>
                                            <div class="modal-footer">
                                                <a href="{{ document.document_file.url }}" class="btn btn-primary" target="_blank">
                                                    <i class="fas fa-download me-1"></i> Download
                                                </a>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Document Edit Modal -->
                                <div class="modal fade" id="editDocumentModal{{ document.id }}" tabindex="-1" aria-labelledby="editDocumentModalLabel{{ document.id }}" aria-hidden="true">
                                    <div class="modal-dialog  modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="editDocumentModalLabel{{ document.id }}">Edit Document</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <form method="POST" enctype="multipart/form-data" action="{% url 'user:edit_document' document.id %}">
                                                {% csrf_token %}
                                                <input type="hidden" name="form_section" value="document">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label for="edit_document_type_{{ document.id }}" class="form-label">Document Type <span class="asteriskField">*</span></label>
                                                        <select name="document_type" id="edit_document_type_{{ document.id }}" class="form-select" required>
                                                            {% for value, label in document_form.fields.document_type.choices %}
                                                                <option value="{{ value }}" {% if value == document.document_type %}selected{% endif %}>{{ label }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="edit_document_file_{{ document.id }}" class="form-label">Document File (Optional - leave empty to keep current file)</label>
                                                        <input type="file" name="document_file" id="edit_document_file_{{ document.id }}" class="form-control" accept="image/*,.pdf,.doc,.docx">
                                                        <small class="text-muted">Current file: {{ document.document_file.name }}</small>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="edit_document_number_{{ document.id }}" class="form-label">Document Number</label>
                                                        <input type="text" name="document_number" id="edit_document_number_{{ document.id }}" class="form-control" placeholder="Enter document number" value="{{ document.document_number|default:'' }}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="edit_issue_date_{{ document.id }}" class="form-label">Issue Date</label>
                                                        <input type="text" name="issue_date" id="edit_issue_date_{{ document.id }}" class="form-control" placeholder="YYYY-MM-DD (BS)" value="{% if document.issue_date %}{{ document.issue_date|to_nepali_date }}{% endif %}">
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="edit_issue_body_{{ document.id }}" class="form-label">Issuing Authority</label>
                                                        <select name="issue_body" id="edit_issue_body_{{ document.id }}" class="form-control select2">
                                                            <option value="">Select Issuing Authority</option>
                                                            {% for district in document_form.fields.issue_body.queryset %}
                                                                <option value="{{ district.id }}" {% if district.id == document.issue_body.id %}selected{% endif %}>{{ district.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="submit" class="btn btn-success">{{ action }}</button>
                                                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cancel</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12">
                                    <div class="alert alert-info mb-0">
                                        <i class="fas fa-info-circle me-2"></i>No documents uploaded yet.
                                    </div>
                                </div>
                                {% endfor %}
                            </div> 
                        </div>                         
                    </div>
                </div>

                 <!-- Payout Tab -->
                 <div class="tab-pane fade {% if active_tab == 'payout' %}show active{% endif %}" id="payout" role="tabpanel">
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="form_section" value="payout">
                        <div class="row">
                            <div class="col-md-6">
                                {{ payout_form|crispy }}
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-success">{{ action }}</button>
                            <a href="{% url 'user:employee_list' %}" class="btn btn-warning">Cancel</a>
                        </div>
                    </form>
                </div>

                <!-- Bank Details Tab -->
                <div class="tab-pane fade {% if active_tab == 'bank_detail' %}show active{% endif %}" id="bank_detail" role="tabpanel">
                    <form method="POST" id="bank-detail-form">
                        {% csrf_token %}
                        <input type="hidden" name="form_section" value="bank_detail">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="bank-detail-forms">
                                    <div class="bank-detail-form-item mb-3">
                                        <div class="row g-3">
                                            <div class="col-md-3 pe-2">
                                                <label for="id_bank_name-0">Bank Name <span class="asteriskField">*</span></label>
                                                <input type="text" name="bank_name-0" id="id_bank_name-0" class="form-control" placeholder="Enter bank name" required>
                                            </div>
                                            <div class="col-md-3 px-2">
                                                <label for="id_bank_username-0">Bank Username <span class="asteriskField">*</span></label>
                                                <input type="text" name="bank_username-0" id="id_bank_username-0" class="form-control" placeholder="Enter bank username" required>
                                            </div>
                                            <div class="col-md-3 px-2">
                                                <label for="id_branch-0">Branch <span class="asteriskField">*</span></label>
                                                <input type="text" name="branch-0" id="id_branch-0" class="form-control" placeholder="Enter branch name" required>
                                            </div>
                                            <div class="col-md-3 ps-2">
                                                <label for="id_account_number-0">Account Number <span class="asteriskField">*</span></label>
                                                <input type="number" name="account_number-0" id="id_account_number-0" class="form-control" placeholder="Enter account number" required>
                                            </div>
                                            <div class="col-md-12">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="is_primary-0" id="id_is_primary-0">
                                                    <label class="form-check-label" for="id_is_primary-0">
                                                        Set as Primary
                                                    </label>
                                                </div>
                                                <div class="alert alert-warning mt-2 primary-create-warning" style="display: none;">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    Marking this as primary will unmark other bank details as primary.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-info" id="add-more-bank-detail">
                                        <i class="fas fa-plus"></i> Add More
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-success">{{ action }}</button>
                            <a href="{% url 'user:employee_list' %}" class="btn btn-warning">Cancel</a>
                        </div>
                    </form>

                    <!-- Display existing bank details -->
                    <div class="card mt-4">
                        <div class="card-header bg-primary text-white fw-bold reduced-padding">Bank Details</div> 
                            <div class="card-body">
                                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                                    {% for bank_detail in bank_details %}
                                    <div class="col">
                                        <div class="card h-100 shadow-sm">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <h6 class="card-title mb-0 text-truncate" style="max-width: 70%;">
                                                        {{ bank_detail.bank_name }}
                                                        {% if bank_detail.is_primary %}
                                                            <span class="badge bg-primary ms-1">Primary</span>
                                                        {% endif %}
                                                    </h6>
                                                </div>
                                                <div class="small text-muted mb-2">
                                                    <div><strong>Branch:</strong> {{ bank_detail.branch }}</div>
                                                    <div><strong>Account:</strong> {{ bank_detail.account_number }}</div>
                                                    {% if bank_detail.bank_username %}
                                                        <div><strong>Username:</strong> {{ bank_detail.bank_username }}</div>
                                                    {% endif %}
                                                </div>

                                                <div class="d-flex gap-2 mt-3">
                                                    <button type="button" class="btn btn-outline-warning btn-sm edit-bank-detail-btn flex-grow-1"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#editBankDetailModal{{ bank_detail.id }}"
                                                        data-bank-detail-id="{{ bank_detail.id }}"
                                                        data-bank-name="{{ bank_detail.bank_name }}"
                                                        data-bank-username="{{ bank_detail.bank_username|default:'' }}"
                                                        data-branch="{{ bank_detail.branch }}"
                                                        data-account-number="{{ bank_detail.account_number }}"
                                                        data-is-primary="{% if bank_detail.is_primary %}true{% else %}false{% endif %}">
                                                        <i class="fas fa-edit me-1"></i> Edit
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger btn-sm delete-btn"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#confirmationModal"
                                                        data-url="{% url 'user:delete_bank_detail' bank_detail.id %}"
                                                        data-title="Delete Bank Detail">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12">
                                        <div class="alert alert-info mb-0">
                                            <i class="fas fa-info-circle me-2"></i>No bank details added yet.
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmationLabel">Confirm Deletion</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this item?</p>
            </div>
            <div class="modal-footer">
                <a href="#" class="btn btn-danger confirmButton">Yes, Delete</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Bank Detail Edit Modals -->
{% for bank_detail in bank_details %}
<div class="modal fade" id="editBankDetailModal{{ bank_detail.id }}" tabindex="-1" role="dialog" aria-labelledby="editBankDetailLabel{{ bank_detail.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header text-white">
                <h5 class="modal-title" id="editBankDetailLabel{{ bank_detail.id }}">Edit Bank Detail</h5>
                <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{% url 'user:edit_bank_detail' bank_detail.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_bank_name_{{ bank_detail.id }}" class="form-label">Bank Name</label>
                        <input type="text" class="form-control" id="edit_bank_name_{{ bank_detail.id }}" name="bank_name" value="{{ bank_detail.bank_name }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_bank_username_{{ bank_detail.id }}" class="form-label">Bank Username</label>
                        <input type="text" class="form-control" id="edit_bank_username_{{ bank_detail.id }}" name="bank_username" value="{{ bank_detail.bank_username|default:'' }}">
                    </div>
                    <div class="mb-3">
                        <label for="edit_branch_{{ bank_detail.id }}" class="form-label">Branch</label>
                        <input type="text" class="form-control" id="edit_branch_{{ bank_detail.id }}" name="branch" value="{{ bank_detail.branch }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_account_number_{{ bank_detail.id }}" class="form-label">Account Number</label>
                        <input type="number" class="form-control" id="edit_account_number_{{ bank_detail.id }}" name="account_number" value="{{ bank_detail.account_number }}" required>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="edit_is_primary_{{ bank_detail.id }}" name="is_primary" {% if bank_detail.is_primary %}checked{% endif %}>
                            <label class="form-check-label" for="edit_is_primary_{{ bank_detail.id }}">
                                Set as Primary
                            </label>
                        </div>
                        <div id="primary-validation-{{ bank_detail.id }}" class="alert alert-warning mt-2" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Another bank detail is already set as primary. Setting this as primary will unmark the other one.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Update</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}
{% endblock content %}

{% block scripts %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Handle tab selection from URL parameter
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const activeTab = urlParams.get('tab');
        if (activeTab) {
            const tabButton = document.querySelector(`button[data-bs-target="#${activeTab}"]`);
            if (tabButton) {
                const tab = new bootstrap.Tab(tabButton);
                tab.show();
            }
        }

        // Initialize select2 for all issue_body dropdowns
        function initializeSelect2() {
            $('select[name^="issue_body"]').select2({
                allowClear: true,
                width: '100%'
            });
        }

        // Initialize select2 on page load
        initializeSelect2();

        // Initialize select2 for edit modal dropdowns when modal is shown
        $('.edit-document-btn').on('click', function() {
            const documentId = $(this).data('document-id');
            const editModal = $(`#editDocumentModal${documentId}`);
            
            editModal.on('shown.bs.modal', function() {
                const editIssueBodySelect = editModal.find('select[name="issue_body"]');
                if (editIssueBodySelect.length) {
                    // Destroy existing select2 if it exists
                    if (editIssueBodySelect.hasClass('select2-hidden-accessible')) {
                        editIssueBodySelect.select2('destroy');
                    }
                    
                    // Reinitialize select2
                    editIssueBodySelect.select2({
                        allowClear: true,
                        width: '100%',
                        dropdownParent: editModal
                    });
                }
                
               // Add toggle functionality for edit modal
                const editDocumentTypeSelect = editModal.find('select[name="document_type"]');
                const editDocumentNumberField = editModal.find('input[name="document_number"]');
                const editIssueDateField = editModal.find('input[name="issue_date"]');
                const editIssueBodyField = editModal.find('select[name="issue_body"]');
                const editDocumentNumberLabel = editModal.find('label[for^="edit_document_number_"]');
                const editIssueDateLabel = editModal.find('label[for^="edit_issue_date_"]');
                const editIssueBodyLabel = editModal.find('label[for^="edit_issue_body_"]');

                function toggleEditIssueFields() {
                    // Hide document number, issue date and issuing authority fields by default
                    editDocumentNumberField.closest('.mb-3').hide();
                    editDocumentNumberField.removeAttribute('required');
                    editIssueDateField.closest('.mb-3').hide();
                    editIssueBodyField.closest('.mb-3').hide();

                    // Remove asterisk if it exists
                    const asterisk = editDocumentNumberLabel.find('.asteriskField');
                    if (asterisk.length) {
                        asterisk.remove();
                    }

                    // Show for specific document types
                    const docType = editDocumentTypeSelect.val();
                    if (docType === 'citizenship_front' || docType === 'citizenship_back' || docType === 'pan_card') {
                        editDocumentNumberField.closest('.mb-3').show();
                        editDocumentNumberField.attr('required', 'required');
                        editIssueDateField.closest('.mb-3').show();
                        editIssueBodyField.closest('.mb-3').show();
                        
                        // Add asterisk if it doesn't exist
                        if (!editDocumentNumberLabel.find('.asteriskField').length) {
                            editDocumentNumberLabel.append(' <span class="asteriskField">*</span>');
                        }
                    }
                }

                // Add event listener to document type select in edit modal
                editDocumentTypeSelect.off('change.toggleIssue').on('change.toggleIssue', toggleEditIssueFields);

                // Initialize on modal show
                toggleEditIssueFields();

            });
        });

        // Handle delete confirmation modal
        $(".delete-btn").on('click', function () {
            var url = $(this).data('url');
            var title = $(this).data('title');
            
            var modal = $("#confirmationModal");
            modal.find('.modal-title').text(title);
            modal.find('.confirmButton').attr('href', url);
        });

        // Track uploaded document types from data attribute
        const uploadedTypes = new Set();
        document.querySelectorAll('[data-document-type]').forEach(function(element) {
            uploadedTypes.add(element.getAttribute('data-document-type'));
        });

        // Function to update document type options
        function updateDocumentTypeOptions(select) {
            const options = select.options;
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.value && uploadedTypes.has(option.value)) {
                    option.disabled = true;
                    if (!option.text.includes('(Already Uploaded)')) {
                        option.text += ' (Already Uploaded)';
                    }
                }
            }
        }

        // Function to toggle issue date and issuing authority fields based on document type
        function toggleIssueFields(documentTypeSelect) {
            const formItem = documentTypeSelect.closest('.document-form-item');
            const documentNumberField = formItem.querySelector('input[name^="document_number-"]');
            const issueDateField = formItem.querySelector('input[name^="issue_date-"]');
            const issueBodyField = formItem.querySelector('select[name^="issue_body-"]');
            const documentNumberLabel = formItem.querySelector('label[for^="id_document_number-"]');
            const issueDateLabel = formItem.querySelector('label[for^="id_issue_date-"]');
            const issueBodyLabel = formItem.querySelector('label[for^="id_issue_body-"]');
            
            // Hide document number, issue date and issuing authority fields by default
            if (documentNumberField) {
                documentNumberField.closest('.col-md-2').style.display = 'none';
                documentNumberField.removeAttribute('required');
            }
            if (issueDateField) {
                issueDateField.closest('.col-md-3').style.display = 'none';
            }
            if (issueBodyField) {
                issueBodyField.closest('.col-md-3').style.display = 'none';
            }
            if (documentNumberLabel) {
                documentNumberLabel.closest('.col-md-2').style.display = 'none';
                // Remove asterisk if it exists
                const asterisk = documentNumberLabel.querySelector('.asteriskField');
                if (asterisk) {
                    asterisk.remove();
                }
            }
            if (issueDateLabel) {
                issueDateLabel.closest('.col-md-3').style.display = 'none';
            }
            if (issueBodyLabel) {
                issueBodyLabel.closest('.col-md-3').style.display = 'none';
            }
            
            // Only show document number, issue date and issuing authority fields for Citizenship Front,  Citizenship Back and Pan Card
            if (documentTypeSelect.value === 'citizenship_front' || documentTypeSelect.value === 'citizenship_back' || documentTypeSelect.value === 'pan_card') {
                if (documentNumberField) {
                    documentNumberField.closest('.col-md-2').style.display = 'block';
                    documentNumberField.setAttribute('required', 'required');
                }
                if (issueDateField) {
                    issueDateField.closest('.col-md-3').style.display = 'block';
                }
                if (issueBodyField) {
                    issueBodyField.closest('.col-md-3').style.display = 'block';
                }
                if (documentNumberLabel) {
                    documentNumberLabel.closest('.col-md-2').style.display = 'block';
                    // Add asterisk if it doesn't exist
                    if (!documentNumberLabel.querySelector('.asteriskField')) {
                        documentNumberLabel.innerHTML += ' <span class="asteriskField">*</span>';
                    }
                }
                if (issueDateLabel) {
                    issueDateLabel.closest('.col-md-3').style.display = 'block';
                }
                if (issueBodyLabel) {
                    issueBodyLabel.closest('.col-md-3').style.display = 'block';
                }
            }
        }

        // Update all existing document type selects
        document.querySelectorAll('.document-type-select').forEach(updateDocumentTypeOptions);

        // Add event listeners to existing document type selects
        document.querySelectorAll('.document-type-select').forEach(function(select) {
            select.addEventListener('change', function() {
                toggleIssueFields(this);
            });
            // Initialize on page load
            toggleIssueFields(select);
        });

        // Document form handling
        const addMoreBtn = document.getElementById('add-more-document');
        const documentForms = document.getElementById('document-forms');
        let formCount = 1;

        if (addMoreBtn) {
            addMoreBtn.addEventListener('click', function() {
                formCount++;
                const newForm = document.querySelector('.document-form-item').cloneNode(true);

                // Update IDs and names to be unique
                const inputs = newForm.querySelectorAll('input, select, label');
                inputs.forEach(input => {
                    if (input.id) input.id = input.id.replace('-0', `-${formCount}`);
                    if (input.name) input.name = input.name.replace('-0', `-${formCount}`);
                    if (input.htmlFor) input.htmlFor = input.htmlFor.replace('-0', `-${formCount}`);
                });

                // Clear values
                newForm.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
                newForm.querySelectorAll('input[type="file"]').forEach(input => input.value = '');
                newForm.querySelectorAll('select').forEach(select => {
                    select.selectedIndex = 0;
                    updateDocumentTypeOptions(select);
                });

                // Remove any select2 containers that may have been cloned
                newForm.querySelectorAll('.select2-container').forEach(el => el.remove());

                // Re-populate the issue_body select with districts, and destroy any select2 instance
                const issueBodySelect = newForm.querySelector('select[name^="issue_body-"]');
                if (issueBodySelect) {
                    if ($(issueBodySelect).hasClass('select2-hidden-accessible')) {
                        $(issueBodySelect).select2('destroy');
                    }
                    // Get the original issue_body select to copy its options
                    const originalIssueBodySelect = document.querySelector('select[name="issue_body-0"]');
                    if (originalIssueBodySelect) {
                        issueBodySelect.innerHTML = originalIssueBodySelect.innerHTML;
                    }
                }

                // Add remove button if not the first form
                if (formCount > 1) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-danger btn-sm mt-2';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
                    removeBtn.onclick = function() {
                        newForm.remove();
                        formCount--;
                    };
                    newForm.appendChild(removeBtn);
                }

                documentForms.appendChild(newForm);

                // Initialize select2 for the newly created issue_body dropdown
                const newIssueBodySelect = newForm.querySelector('select[name^="issue_body-"]');
                if (newIssueBodySelect) {
                    $(newIssueBodySelect).select2({
                        allowClear: true,
                        width: '100%'
                    });
                }

                // Add event listener to the new document type select
                const newDocumentTypeSelect = newForm.querySelector('select[name^="document_type-"]');
                if (newDocumentTypeSelect) {
                    newDocumentTypeSelect.addEventListener('change', function() {
                        toggleIssueFields(this);
                    });
                    // Initialize on creation
                    toggleIssueFields(newDocumentTypeSelect);
                }

                // Initialize Nepali date picker for the new issue date field
                const newIssueDateField = newForm.querySelector('input[name^="issue_date-"]');
                if (newIssueDateField) {
                    newIssueDateField.nepaliDatePicker();
                }
            });
        }

        // Preview profile picture before upload
        const profilePictureInput = document.getElementById('id_profile_profile_picture');
        const profilePreview = document.getElementById('profile-preview');

        if (profilePictureInput) {
            profilePictureInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Remove the icon if it exists
                        const icon = profilePreview.closest('.profile-picture-container').querySelector('.fa-user');
                        if (icon) {
                            icon.remove();
                        }
                        
                        // Create or update the image
                        if (profilePreview.tagName === 'IMG') {
                            profilePreview.src = e.target.result;
                        } else {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.alt = 'Profile Picture';
                            img.id = 'profile-preview';
                            profilePreview.parentNode.replaceChild(img, profilePreview);
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Sync file selection from original input to hidden one
        const fileInput = document.getElementById('id_profile_profile_picture');
        const profileForm = document.getElementById('profile-form');
        if (fileInput && profileForm) {
            // Clone the input to preserve event listeners and UI
            const clonedInput = fileInput.cloneNode(true);
            clonedInput.style.display = 'none';  // hide it in form
            profileForm.appendChild(clonedInput);

            // Sync file selection from original input to hidden one
            fileInput.addEventListener('change', function () {
                clonedInput.files = fileInput.files;
            });
        }

        // Bank detail form handling with dynamic forms
        const addMoreBankDetailBtn = document.getElementById('add-more-bank-detail');
        const bankDetailForms = document.getElementById('bank-detail-forms');
        let bankDetailFormCount = 1;

        // Simple function to handle primary checkbox changes
        function handlePrimaryCheckboxChange(changedCheckbox) {
            const allPrimaryCheckboxes = document.querySelectorAll('input[name^="is_primary-"]');
            
            // Check if there are existing primary bank details in the displayed cards
            const existingPrimaryBankDetails = document.querySelectorAll('.card-body .badge.bg-primary');
            const hasOtherPrimary = existingPrimaryBankDetails.length > 0;
            
            // Find the alert div for this checkbox
            const alertDiv = changedCheckbox.closest('.col-md-12').querySelector('.primary-create-warning');
            
            // If setting primary and there's already a primary bank detail, show alert
            if (changedCheckbox.checked && hasOtherPrimary) {
                if (alertDiv) {
                    alertDiv.style.display = 'block';
                    // Update the warning message to be more specific
                    const warningText = alertDiv.querySelector('i').nextSibling;
                    if (warningText) {
                        warningText.textContent = ` Marking this as primary will unmark existing primary bank detail.`;
                    }
                }
            } else {
                if (alertDiv) alertDiv.style.display = 'none';
            }
            
            // If this checkbox is being checked, uncheck all other checkboxes in the form
            if (changedCheckbox.checked) {
                allPrimaryCheckboxes.forEach(checkbox => {
                    if (checkbox !== changedCheckbox) {
                        checkbox.checked = false;
                        // Hide their alerts too
                        const otherAlertDiv = checkbox.closest('.col-md-12').querySelector('.primary-create-warning');
                        if (otherAlertDiv) otherAlertDiv.style.display = 'none';
                    }
                });
                
                // Remove any suggestion messages when a primary is selected
                document.querySelectorAll('.primary-suggestion').forEach(suggestion => {
                    suggestion.remove();
                });
            } else {
                // If unchecking and there are no existing primary bank details, suggest keeping one primary
                if (!hasOtherPrimary && allPrimaryCheckboxes.length > 1) {
                    const checkedCount = Array.from(allPrimaryCheckboxes).filter(cb => cb.checked).length;
                    if (checkedCount === 0) {
                        // Show a gentle suggestion to keep at least one primary
                        const suggestionDiv = changedCheckbox.closest('.col-md-12').querySelector('.primary-suggestion');
                        if (!suggestionDiv) {
                            const newSuggestionDiv = document.createElement('div');
                            newSuggestionDiv.className = 'alert alert-info mt-2 primary-suggestion';
                            newSuggestionDiv.innerHTML = '<i class="fas fa-info-circle me-2"></i> Consider marking one bank detail as primary for easier identification.';
                            changedCheckbox.closest('.col-md-12').appendChild(newSuggestionDiv);
                        }
                    }
                }
            }
        }

        // Add event listeners to primary checkboxes
        function addPrimaryCheckboxListeners() {
            document.querySelectorAll('input[name^="is_primary-"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    handlePrimaryCheckboxChange(this);
                });
            });
        }

        if (addMoreBankDetailBtn) {
            addMoreBankDetailBtn.addEventListener('click', function() {
                bankDetailFormCount++;
                const newForm = document.querySelector('.bank-detail-form-item').cloneNode(true);

                // Update IDs and names to be unique
                const inputs = newForm.querySelectorAll('input, label');
                inputs.forEach(input => {
                    if (input.id) input.id = input.id.replace('-0', `-${bankDetailFormCount}`);
                    if (input.name) input.name = input.name.replace('-0', `-${bankDetailFormCount}`);
                    if (input.htmlFor) input.htmlFor = input.htmlFor.replace('-0', `-${bankDetailFormCount}`);
                });

                // Clear values
                newForm.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
                newForm.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
                newForm.querySelectorAll('input[type="checkbox"]').forEach(input => input.checked = false);

                // Add remove button if not the first form
                if (bankDetailFormCount > 1) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.className = 'btn btn-danger btn-sm mt-2';
                    removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
                    removeBtn.onclick = function() {
                        newForm.remove();
                        bankDetailFormCount--;
                    };
                    newForm.appendChild(removeBtn);
                }

                bankDetailForms.appendChild(newForm);
                
                // Add listeners to the new checkbox
                const newCheckbox = newForm.querySelector('input[name^="is_primary-"]');
                if (newCheckbox) {
                    newCheckbox.addEventListener('change', function() {
                        handlePrimaryCheckboxChange(this);
                    });
                }
            });
        }

        // Initialize primary checkbox listeners on page load
        addPrimaryCheckboxListeners();

        // Handle primary checkbox validation in edit modals
        $('.edit-bank-detail-btn').on('click', function() {
            const bankDetailId = $(this).data('bank-detail-id');
            const isCurrentlyPrimary = $(this).data('is-primary') === 'true';
            const editModal = $(`#editBankDetailModal${bankDetailId}`);
            
            editModal.on('shown.bs.modal', function() {
                const primaryCheckbox = editModal.find(`#edit_is_primary_${bankDetailId}`);
                const validationDiv = editModal.find(`#primary-validation-${bankDetailId}`);
                
                // Check if there are other primary bank details (excluding current one if it's already primary)
                const otherPrimaryBankDetails = $('.card-body .badge.bg-primary').length;
                const hasOtherPrimary = isCurrentlyPrimary ? otherPrimaryBankDetails > 1 : otherPrimaryBankDetails > 0;
                
                // Add event listener to primary checkbox
                primaryCheckbox.off('change.primaryValidation').on('change.primaryValidation', function() {
                    if (this.checked && hasOtherPrimary) {
                        validationDiv.show();
                        // Update the warning message to be more specific
                        const warningText = validationDiv.find('i').next();
                        if (warningText.length) {
                            const otherCount = isCurrentlyPrimary ? otherPrimaryBankDetails - 1 : otherPrimaryBankDetails;
                            warningText.text(` Another bank detail${otherCount > 1 ? 's are' : ' is'} already set as primary. Setting this as primary will unmark the other${otherCount > 1 ? 's' : ''} as primary.`);
                        }
                    } else {
                        validationDiv.hide();
                    }
                });
                
                // Initialize validation state
                if (primaryCheckbox.is(':checked') && hasOtherPrimary) {
                    validationDiv.show();
                    // Update the warning message to be more specific
                    const warningText = validationDiv.find('i').next();
                    if (warningText.length) {
                        const otherCount = isCurrentlyPrimary ? otherPrimaryBankDetails - 1 : otherPrimaryBankDetails;
                        warningText.text(` Another bank detail${otherCount > 1 ? 's are' : ' is'} already set as primary. Setting this as primary will unmark the other${otherCount > 1 ? 's' : ''} as primary.`);
                    }
                } else {
                    validationDiv.hide();
                }
            });
        });

        // Bank detail form submission handling
        const bankDetailForm = document.getElementById('bank-detail-form');
        if (bankDetailForm) {
            bankDetailForm.addEventListener('submit', function(e) {
                // Check if any new bank detail is being marked as primary
                const newPrimaryCheckboxes = document.querySelectorAll('input[name^="is_primary-"]:checked');
                const existingPrimaryBankDetails = document.querySelectorAll('.card-body .badge.bg-primary');
                
                if (newPrimaryCheckboxes.length > 0 && existingPrimaryBankDetails.length > 0) {
                    const confirmMessage = `You are marking new bank detail as primary. This will unmark existing primary bank detail. Do you want to continue?`;
                    if (!confirm(confirmMessage)) {
                        e.preventDefault();
                        return false;
                    }
                }
                
                // Validate that at least one bank detail has required fields
                const bankDetailFormItems = document.querySelectorAll('.bank-detail-form-item');
                let hasValidData = false;
                
                bankDetailFormItems.forEach((formItem, index) => {
                    const bankNameField = formItem.querySelector('input[name^="bank_name-"]');
                    const branchField = formItem.querySelector('input[name^="branch-"]');
                    const accountNumberField = formItem.querySelector('input[name^="account_number-"]');
                    
                    const bankName = bankNameField.value.trim();
                    const branch = branchField.value.trim();
                    const accountNumber = accountNumberField.value.trim();
                    
                    // Only include if at least required fields are filled
                    if (bankName && branch && accountNumber) {
                        hasValidData = true;
                    }
                });
                
                if (!hasValidData) {
                    alert('Please fill in at least one bank detail with required fields (Bank Name, Branch, Account Number).');
                    e.preventDefault();
                    return false;
                }
                
            });
        }

        // Function to refresh the display of existing bank details
        function refreshBankDetailsDisplay() {
            const bankDetailsContainer = document.querySelector('.card-body .row');
            if (bankDetailsContainer) {
                // Trigger a small animation to indicate update
                bankDetailsContainer.style.opacity = '0.7';
                setTimeout(() => {
                    bankDetailsContainer.style.opacity = '1';
                }, 200);
            }
        }

        // Function to update primary status indicators
        function updatePrimaryStatusIndicators() {
            const primaryBadges = document.querySelectorAll('.card-body .badge.bg-primary');
            const primaryCheckboxes = document.querySelectorAll('input[name^="is_primary-"]');
            
            // If there are existing primary bank details, show appropriate warnings
            if (primaryBadges.length > 0) {
                primaryCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        const alertDiv = checkbox.closest('.col-md-12').querySelector('.primary-create-warning');
                        if (alertDiv) {
                            alertDiv.style.display = 'block';
                            const warningText = alertDiv.querySelector('i').nextSibling;
                            if (warningText) {
                                warningText.textContent = ` Marking this as primary will unmark ${primaryBadges.length} existing primary bank detail${primaryBadges.length > 1 ? 's' : ''} as primary.`;
                            }
                        }
                    }
                });
            }
        }

        // Initialize primary checkbox listeners on page load
        addPrimaryCheckboxListeners();
        
        // Update primary status indicators on page load
        updatePrimaryStatusIndicators();

        window.onload = function () {
            var joining_date = document.getElementById("joining_date");
            if (joining_date) {
                joining_date.nepaliDatePicker();
            }

            $('.nep_date').nepaliDatePicker()

            // Initialize Nepali date picker for all issue date fields
            document.querySelectorAll('input[id^="id_issue_date-"]').forEach(function(element) {
                element.nepaliDatePicker();
            });
        };
    });
</script>
{% endblock scripts %}