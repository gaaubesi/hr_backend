{% extends 'base.html' %}
{% load nepali_date %}
{% load custom_filters %}

{% block title %}
    Roster List
{% endblock title %}

 {% block styles %}
    <style>
        .sticky-col {
            position: sticky;
            background: #f8f9fa; /* bg-light for <td>, overridden for <th> */
            left: 0;
            z-index: 2;
        }

        thead .sticky-col {
            z-index: 3;
            background: #343a40; /* bg-dark */
            color: #fff;
        }
    </style>

 {% endblock styles %}

{% block content %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white fw-bold reduced-padding">
            ADVANCE FILTER
        </div>
        <div class="card-body mt-3">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Date</label>
                    <input type="text" class="form-control nep_date" name="date" 
                        value="{{ selected_date }}" placeholder="YYYY-MM-DD">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Department</label>
                    <select name="department" id="departmentDropdown" class="form-select">
                        <option value="">All</option>
                        {% for department in all_departments %}
                            <option value="{{ department.id }}" {% if department.id|stringformat:"s" == selected_department %}selected{% endif %}>
                                {{ department.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Employee</label>
                    <select name="employee" id="employeeDropdown" class="form-select">
                        <option value="">All</option>
                        {% for employee in all_users %}
                            <option value="{{ employee.id }}" {% if employee.id|stringformat:"s" == selected_employee %}selected{% endif %}>
                                {{ employee.full_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>


                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-outline-primary me-2">
                        <i class="fas fa-filter me-1"></i> Filter
                    </button>
                    <a href="{% url 'roster:roster_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-1"></i> Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <i class="fa fa-layer-group text-primary me-2 fs-4"></i>
            <h3 class="mb-0 fw-bold text-dark">Roster List</h3>
        </div>
    </div>

    <div class="table-responsive text-nowrap" style="overflow-x: auto;">
        <table class="table table-bordered text-nowrap table-hover align-middle">
            <thead class="table-dark">
                <tr class="text_white text-center">
                    <th class="sticky-col bg-dark text-white text-start" style="min-width: 200px; left: 0; z-index: 3;">
                        Employee
                    </th>

                    {% for day in days %}
                        <th>{{day.0|to_nepali_date}}</th>
                    {% endfor %}
                </tr>
            </thead>

            <tbody>
                {% for user in filtered_users %}
                    <tr>
                        <td class="align-middle font-weight-bold sticky-col" style="left: 0; z-index: 2; background-color: #c9cafd;">
                            {{ user.full_name }}
                        </td>


                        {% for day in days %}
                            {% with shifts=roster_map|get_item:user.id|get_item:day.0 %}
                                <td class="position-relative" style="min-width: 180px;">
                                    {% if shifts %}
                                        {% for detail in shifts %}
                                            {% with shift=detail.shift %}
                                                <div class="mb-1 p-2 rounded text-white"
                                                    style="background-color: {{ shift.colour|default:'#999' }};">
                                                    <div class="d-flex align-items-start justify-content-between">
                                                        
                                                        {% if detail.roster.roster_details.count > 1 %}
                                                            <div class="text-danger delete-shift-btn" 
                                                            data-detail-id="{{ detail.id }}" 
                                                            style="cursor: pointer;">
                                                            <i class="fas fa-trash-alt"></i>
                                                            </div>
                                                        {% endif %}

                                                        <div>
                                                            <strong>{{ shift.title }}</strong><br>
                                                            {% comment %} <small>{{ user.full_name }}</small><br> {% endcomment %}
                                                            {{ shift.start_time|time:"g:i A" }} - {{ shift.end_time|time:"g:i A" }}
                                                        </div>

                                                        <a href="#" class="text-white ml-2 edit-shift-btn" 
                                                            data-detail-id="{{ detail.id }}" 
                                                            data-shift-id="{{ shift.id }}" 
                                                            data-roster-id="{{ detail.roster_id }}">
                                                            <i class="fas fa-pen-square"></i>
                                                        </a>

                                                    </div>
                                                </div>
                                            {% endwith %}
                                        {% endfor %}
                                    {% endif %}
                                    <div class="position-absolute" style="bottom: 4px; right: 6px;">
                                        <a href="#" class="add-shift-btn" 
                                            data-employee="{{ user.id }}" 
                                            data-date="{{ day.0 }}">
                                            <i class="fas fa-plus-circle text-dark"></i>
                                        </a>
                                    </div>
                                </td>
                            {% endwith %}
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        {% include "includes/pagination.html" %}
    </div> 

    <!-- Shift Add Modal -->
    <div class="modal fade" id="addShiftModal" tabindex="-1" aria-labelledby="addShiftModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addShiftForm" method="post">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="addShiftModalLabel">Assign Shift</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="employee_id" id="modalEmployeeId">
                        <input type="hidden" name="date" id="modalDate">

                        <div class="mb-3">
                            <label for="shiftSelect" class="form-label">Select Shift</label>
                            <select class="form-select" id="shiftSelect" name="shift_id" required>
                                <option value="">-- Select Shift --</option>
                                {% for shift in all_shifts %}
                                    <option value="{{ shift.id }}">{{ shift.title }} ({{ shift.start_time|time:"g:i A" }} - {{ shift.end_time|time:"g:i A" }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Assign</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Shift Modal -->
    <div class="modal fade" id="editShiftModal" tabindex="-1" aria-labelledby="editShiftLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editShiftForm">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="editShiftLabel">Edit Shift</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <div class="modal-body">
                        <input type="hidden" name="detail_id" id="edit-detail-id">
                        <input type="hidden" name="roster_id" id="edit-roster-id">
                        
                        <div class="mb-3">
                            <label for="edit-shift-id" class="form-label">Select Shift</label>
                            <select name="shift_id" id="edit-shift-id" class="form-select">
                            {% for shift in all_shifts %}
                                <option value="{{ shift.id }}">{{ shift.title }}</option>
                            {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Shift</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        $(document).ready(function () {
            $('#departmentDropdown').on('change', function () {
                var departmentId = $(this).val();
                $.ajax({
                    url: "{% url 'roster:ajax_get_employees' %}",
                    type: "GET",
                    data: {
                        department_id: departmentId
                    },
                    success: function (data) {
                        var employeeDropdown = $('#employeeDropdown');
                        employeeDropdown.empty();
                        employeeDropdown.append('<option value="">All</option>');

                        $.each(data.employees, function (index, employee) {
                            var fullName = employee.first_name + ' ' + employee.last_name;
                            employeeDropdown.append(
                                $('<option>', {
                                    value: employee.id,
                                    text: fullName
                                })
                            );
                        });
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching employees:', error);
                    }
                });
            });

            function formatDate(inputDateStr) {
                // Example input: "May 26, 2025"
                let date = new Date(inputDateStr);
                
                if (isNaN(date)) {
                    console.error("Invalid date:", inputDateStr);
                    return '';
                }

                let year = date.getFullYear();
                let month = String(date.getMonth() + 1).padStart(2, '0'); // months are 0-indexed
                let day = String(date.getDate()).padStart(2, '0');

                return `${year}-${month}-${day}`;  // e.g., "2025-05-26"
            }

            // Trigger modal on clicking "add shift"
            $('.add-shift-btn').on('click', function (e) {
                e.preventDefault();
                const employeeId = $(this).data('employee');
                const rawDate = $(this).data('date');
                const formattedDate = formatDate(rawDate);

                if (!formattedDate) {
                    alert("Invalid date format");
                    return;
                }
                $('#modalEmployeeId').val(employeeId);
                $('#modalDate').val(formattedDate);
                $('#shiftSelect').val('');

                $('#addShiftModal').modal('show');
            });

            // Open modal with existing values
            $('.edit-shift-btn').click(function (e) {
                e.preventDefault();
                const detailId = $(this).data('detail-id');
                const shiftId = $(this).data('shift-id');
                const rosterId = $(this).data('roster-id');

                $('#edit-detail-id').val(detailId);
                $('#edit-shift-id').val(shiftId);
                $('#edit-roster-id').val(rosterId);

                $('#edit-shift-id').val(shiftId); // Preselect shift
                $('#editShiftModal').modal('show');
            });

            // Handle update form submission
            $('#editShiftForm').submit(function (e) {
                e.preventDefault();

                $.ajax({
                    url: "{% url 'roster:ajax_edit_shift' %}",
                    type: "POST",
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function (xhr) {
                        alert('Something went wrong!');
                    }
                });
            });

            // Open modal with existing values
            $('.edit-shift-btn').click(function (e) {
                e.preventDefault();
                const detailId = $(this).data('detail-id');
                const shiftId = $(this).data('shift-id');
                const rosterId = $(this).data('roster-id');

                $('#edit-detail-id').val(detailId);
                $('#edit-shift-id').val(shiftId);
                $('#edit-roster-id').val(rosterId);

                $('#edit-shift-id').val(shiftId); // Preselect shift
                $('#editShiftModal').modal('show');
            });

            // Handle update form submission
            $('#editShiftForm').submit(function (e) {
                e.preventDefault();
                $.ajax({
                    url: "{% url 'roster:ajax_edit_shift' %}",
                    type: "POST",
                    data: $(this).serialize(),
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.error);
                        }
                    },
                    error: function (xhr) {
                        alert('Something went wrong!');
                    }
                });
            });

            //Delete shift button functionality
            $('.delete-shift-btn').click(function () {
                var detailId = $(this).data('detail-id');
                
                if (confirm("Are you sure you want to delete this shift?")) {
                    $.ajax({
                        url: "{% url 'roster:delete_shift_ajax' %}",
                        type: "POST",
                        data: {
                            detail_id: detailId,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function (response) {
                            if (response.success) {
                                location.reload(); // Refresh page to reflect deletion
                            } else {
                                alert(response.error || "An error occurred.");
                            }
                        },
                        error: function (xhr) {
                            alert("Something went wrong while deleting.");
                        }
                    });
                }
            });

            // Optional: handle form submission via AJAX
            $('#addShiftForm').on('submit', function (e) {
                e.preventDefault();

                const formData = $(this).serialize();

                $.ajax({
                    url: "{% url 'roster:add_shift_ajax' %}",
                    method: "POST",
                    data: formData,
                    success: function (response) {
                    location.reload();
                    },
                    error: function (xhr) {
                    alert('Error assigning shift');
                    }
                });
            });
        });
    </script>
{% endblock scripts %}




  
